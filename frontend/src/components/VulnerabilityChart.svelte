<script>
    import { onMount } from "svelte";
    import { vulnerabilities } from "../lib/vulnerabilityStore.js";
    import { derived } from 'svelte/store';
    import * as d3 from "d3";
    export let vulnerabilities;
    let chartContainer;

    // Dados derivados da store
    const data = derived(vulnerabilities, ($vulnerabilities) => ({
        name: "Vulnerabilidades",
        children: $vulnerabilities.map(vuln => ({
            name: vuln.title,
            children: [{ name: vuln.title, value: vuln.value }]
        }))
    }));

    $: data.subscribe(drawSunburst);

    function drawSunburst(currentData) {
        if (!chartContainer || !currentData) return;

        d3.select(chartContainer).selectAll("*").remove();

        const width = 400, height = 400, radius = Math.min(width, height) / 2;

        const color = d3.scaleOrdinal()
            .domain(["Critical", "High", "Medium", "Low", "Unknown"])
            .range(["#cb2d3e", "#fc4a1a", "#f09819", "#dce35b", "#00b4db"]);

        const partition = d3.partition().size([2 * Math.PI, radius]);

        const root = d3.hierarchy(currentData).sum(d => d.value);
        partition(root);

        const arc = d3.arc()
            .startAngle(d => d.x0).endAngle(d => d.x1)
            .innerRadius(d => d.y0).outerRadius(d => d.y1);

        const svg = d3.select(chartContainer)
            .append("svg")
            .attr("viewBox", [-width / 2, -height / 2, width, height]);

        svg.selectAll("path")
            .data(root.descendants().filter(d => d.depth))
            .join("path")
            .attr("fill", d => color(d.data.name))
            .attr("d", arc)
            .append("title")
            .text(d => `${d.data.name}: ${d.value}`);
    }
</script>

<div class="chart-container">
    <h2 class="chart-title">Distribuição das Principais Vulnerabilidades</h2>
    <div bind:this={chartContainer} class="sunburst-chart"></div>
</div>
